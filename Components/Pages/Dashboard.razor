@page "/dashboard"
@using Journal_App_MAUI.Models
@using Journal_App_MAUI.Services
@inject JournalService JournalService
@inject IJSRuntime JS

<h3 class="text-primary mb-4">Dashboard Analytics & Insights</h3>

<div class="mb-3">
    <label class="form-label">Date Range</label>
    <input type="date" @bind-Value="startDate" @bind-Value:event="onchange" />
    <input type="date" @bind-Value="endDate" @bind-Value:event="onchange" />
    <button class="btn btn-primary ms-2" @onclick="LoadAnalytics">Apply</button>
</div>

@if (entries == null)
{
    <p>Loading analytics...</p>
}
else
{
    <div class="row">
        <div class="col-md-6">
            <canvas id="moodChart"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="tagChart"></canvas>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <canvas id="wordTrendChart"></canvas>
        </div>
        <div class="col-md-6">
            <h5>Insights</h5>
            <ul>
                <li><strong>Most Frequent Mood:</strong> @mostFrequentMood</li>
                <li><strong>Daily Streak:</strong> @dailyStreak days</li>
                <li><strong>Longest Streak:</strong> @longestStreak days</li>
                <li><strong>Missed Days:</strong> @string.Join(", ", missedDays.Select(d => d.ToShortDateString()))</li>
            </ul>
        </div>
    </div>
}

@code {
    private List<JournalEntry>? entries;
    private DateTime startDate = DateTime.Today.AddMonths(-1);
    private DateTime endDate = DateTime.Today;

    private string mostFrequentMood = "";
    private int dailyStreak = 0;
    private int longestStreak = 0;
    private List<DateTime> missedDays = new();

    protected override async Task OnInitializedAsync()
    {
        await JournalService.InitializeAsync();
        await LoadAnalytics();
    }

    private async Task LoadAnalytics()
    {
        var allEntries = await JournalService.GetAllEntries(1); // Replace with logged-in user ID
        entries = allEntries
            .Where(e => e.EntryDate.Date >= startDate.Date && e.EntryDate.Date <= endDate.Date)
            .OrderBy(e => e.EntryDate)
            .ToList();

        if (entries.Any())
        {
            ComputeMoodStats();
            ComputeStreaks();
            ComputeMissedDays();
            ComputeWordTrends();
            await RenderCharts();
        }
    }

    private void ComputeMoodStats()
    {
        mostFrequentMood = entries
            .GroupBy(e => e.PrimaryMood)
            .OrderByDescending(g => g.Count())
            .FirstOrDefault()?.Key ?? "None";
    }

    private void ComputeStreaks()
    {
        var dates = entries.Select(e => e.EntryDate.Date).Distinct().OrderBy(d => d).ToList();
        int currentStreak = 0, maxStreak = 0;
        DateTime? prev = null;

        foreach (var d in dates)
        {
            if (prev.HasValue && (d - prev.Value).Days == 1)
            {
                currentStreak++;
            }
            else
            {
                currentStreak = 1;
            }
            maxStreak = Math.Max(maxStreak, currentStreak);
            prev = d;
        }

        dailyStreak = currentStreak;
        longestStreak = maxStreak;
    }

    private void ComputeMissedDays()
    {
        missedDays.Clear();
        var range = Enumerable.Range(0, (endDate - startDate).Days + 1)
            .Select(offset => startDate.AddDays(offset))
            .ToList();

        var entryDates = entries.Select(e => e.EntryDate.Date).ToHashSet();
        missedDays = range.Where(d => !entryDates.Contains(d)).ToList();
    }

    private void ComputeWordTrends()
    {
        // Word count trend is computed in JS chart rendering
    }

    private async Task RenderCharts()
    {
        // Mood Distribution
        var moodData = entries.GroupBy(e => e.PrimaryMood)
            .Select(g => new { Mood = g.Key, Count = g.Count() }).ToList();

        await JS.InvokeVoidAsync("renderPieChart", "moodChart",
            moodData.Select(m => m.Mood).ToArray(),
            moodData.Select(m => m.Count).ToArray());

        // Tag Breakdown
        var tagData = entries.SelectMany(e => (e.Tags ?? "").Split(',', StringSplitOptions.RemoveEmptyEntries))
            .GroupBy(t => t.Trim())
            .Select(g => new { Tag = g.Key, Count = g.Count() }).ToList();

        await JS.InvokeVoidAsync("renderBarChart", "tagChart",
            tagData.Select(t => t.Tag).ToArray(),
            tagData.Select(t => t.Count).ToArray());

        // Word Count Trends
        var wordTrendData = entries.Select(e => new { Date = e.EntryDate.ToShortDateString(), Count = e.WordCount }).ToList();

        await JS.InvokeVoidAsync("renderLineChart", "wordTrendChart",
            wordTrendData.Select(w => w.Date).ToArray(),
            wordTrendData.Select(w => w.Count).ToArray());
    }
}
