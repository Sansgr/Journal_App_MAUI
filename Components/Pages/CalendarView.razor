@page "/calendar"
@using Journal_App_MAUI.Models
@using Journal_App_MAUI.Services
@inject JournalService JournalService

<h3 class="text-primary mb-4">Journal Calendar</h3>

<!-- Highlight current month and year -->
<h4 class="text-center mb-3">@currentMonth.ToString("MMMM yyyy")</h4>

@if (entries == null)
{
    <p>Loading calendar...</p>
}
else
{
    <div class="calendar-grid">
        @foreach (var day in Enumerable.Range(1, DateTime.DaysInMonth(currentMonth.Year, currentMonth.Month)))
        {
            var date = new DateTime(currentMonth.Year, currentMonth.Month, day);

            <div class="calendar-cell 
                        @(date.Date == DateTime.Today ? "today" : "") 
                        @(selectedDate.HasValue && selectedDate.Value.Date == date.Date ? "selected" : "")"
                 @onclick="() => SelectDate(date)">
                <div class="date-number">@day</div>
            </div>
        }
    </div>

    <div class="mt-3 text-center">
        <button class="btn btn-secondary me-2" @onclick="PrevMonth">Previous</button>
        <button class="btn btn-secondary" @onclick="NextMonth">Next</button>
    </div>

    <!-- Journal list for selected date -->
    @if (selectedDate != null)
    {
        <h5 class="mt-4">Entries for @selectedDate?.ToLongDateString()</h5>
        var dayEntries = entries.Where(e => e.EntryDate.Date == selectedDate.Value.Date).ToList();

        @if (dayEntries.Any())
        {
            <ul class="list-group mt-2">
                @foreach (var e in dayEntries)
                {
                    <li class="list-group-item">
                        <strong>@e.Title</strong>  
                        <div class="text-muted">@e.EntryDate.ToShortTimeString()</div>
                        <div>@((MarkupString)Markdig.Markdown.ToHtml(e.Content))</div>
                        <div class="mt-2">
                            <a class="btn btn-primary btn-sm me-2" href="@($"/journals/edit/{e.EntryId}")">Edit</a>
                            <a class="btn btn-secondary btn-sm" href="@($"/journals/{e.EntryId}")">View</a>
                        </div>
                    </li>
                }
            </ul>
        }
        else
        {
            <p class="text-muted">No entries for this date.</p>
        }
    }
}

@code {
    private List<JournalEntry>? entries;
    private DateTime currentMonth = DateTime.Today;
    private DateTime? selectedDate;

    protected override async Task OnInitializedAsync()
    {
        await JournalService.InitializeAsync();
        entries = await JournalService.GetAllEntries(1); // Replace with logged-in user ID
    }

    private async Task LoadEntries()
    {
        entries = await JournalService.GetAllEntries(1);
        StateHasChanged();
    }

    private async Task PrevMonth()
    {
        currentMonth = currentMonth.AddMonths(-1);
        await LoadEntries();
    }

    private async Task NextMonth()
    {
        currentMonth = currentMonth.AddMonths(1);
        await LoadEntries();
    }

    private void SelectDate(DateTime date)
    {
        selectedDate = date;
    }
}
