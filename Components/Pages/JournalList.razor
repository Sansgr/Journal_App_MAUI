@page "/journals"
@using Journal_App_MAUI.Models
@using Journal_App_MAUI.Services
@inject JournalService JournalService

<h3 class="text-primary mb-4">Journal Entries</h3>

<!-- Search & Filter Controls -->
<div class="card p-3 mb-3">
    <div class="row">
        <div class="col-md-4 mb-2">
            <input class="form-control" placeholder="Search by title or content"
                   @bind-Value="searchText" @bind-Value:event="oninput" />
        </div>
        <div class="col-md-3 mb-2">
            <input type="date" class="form-control" @bind-Value="filterDate" @bind-Value:event="onchange" />
        </div>
        <div class="col-md-2 mb-2">
            <select class="form-select" @bind-Value="filterMood" @bind-Value:event="onchange">
                <option value="">All Moods</option>
                <option value="Positive">Positive</option>
                <option value="Neutral">Neutral</option>
                <option value="Negative">Negative</option>
            </select>
        </div>
        <div class="col-md-3 mb-2">
            <input class="form-control" placeholder="Filter by tags (comma separated)"
                   @bind-Value="filterTags" @bind-Value:event="oninput" />
        </div>
    </div>
    <button class="btn btn-primary mt-2" @onclick="ApplyFilters">Apply Filters</button>
    <button class="btn btn-secondary mt-2 ms-2" @onclick="ClearFilters">Clear</button>
</div>

@if (pagedEntries == null)
{
    <p>Loading entries...</p>
}
else
{
    <!-- Streak Tracking Section -->
    <div class="card p-3 mb-3">
        <h5>Streak Tracking</h5>
        <ul>
            <li><strong>Daily Streak:</strong> @dailyStreak days</li>
            <li><strong>Longest Streak:</strong> @longestStreak days</li>
            <li>
                <strong>Missed Days:</strong>
                @if (missedDays.Any())
                {
                    @string.Join(", ", missedDays.Select(d => d.ToShortDateString()))
                }
                else
                {
                    <span>None</span>
                }
            </li>
        </ul>
    </div>

    <!-- Journal Entries -->
    <div class="list-group">
        @foreach (var e in pagedEntries)
        {
            <div class="list-group-item mb-3">
                <h5>
                    <a href="@($"/journals/{e.EntryId}")">@e.Title</a>
                </h5>
                <small class="text-muted">@e.EntryDate.ToShortDateString()</small>

                <div class="mt-2">
                    @((MarkupString)Markdig.Markdown.ToHtml(e.Content))
                </div>

                <div class="mt-3">
                    <a class="btn btn-primary btn-sm me-2" href="@($"/journals/edit/{e.EntryId}")">Edit</a>
                    <button class="btn btn-danger btn-sm" @onclick="() => DeleteEntry(e)">Delete</button>
                </div>
            </div>
        }
    </div>

    <!-- Pagination Controls -->
    <div class="mt-3 d-flex justify-content-between align-items-center">
        <button class="btn btn-secondary" @onclick="PrevPage" disabled="@(!CanPrev)">Previous</button>
        <span>Page @currentPage of @totalPages</span>
        <button class="btn btn-secondary" @onclick="NextPage" disabled="@(!CanNext)">Next</button>
    </div>
}

@code {
    private List<JournalEntry>? entries;
    private List<JournalEntry>? filteredEntries;
    private List<JournalEntry>? pagedEntries;

    private int currentPage = 1;
    private int pageSize = 5;
    private int totalPages = 1;

    //  Search & Filter fields
    private string searchText = "";
    private DateTime? filterDate;
    private string filterMood = "";
    private string filterTags = "";

    // Streak Tracking fields
    private int dailyStreak = 0;
    private int longestStreak = 0;
    private List<DateTime> missedDays = new();

    protected override async Task OnInitializedAsync()
    {
        await JournalService.InitializeAsync();
        entries = await JournalService.GetAllEntries(1); 
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        if (entries == null) return;

        filteredEntries = entries.Where(e =>
            (string.IsNullOrEmpty(searchText) ||
                (e.Title?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (e.Content?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false)) &&
            (!filterDate.HasValue || e.EntryDate.Date == filterDate.Value.Date) &&
            (string.IsNullOrEmpty(filterMood) || e.PrimaryMood?.Equals(filterMood, StringComparison.OrdinalIgnoreCase) == true) &&
            (string.IsNullOrEmpty(filterTags) ||
                filterTags.Split(',', StringSplitOptions.RemoveEmptyEntries)
                          .Any(tag => (e.Tags ?? "").Contains(tag.Trim(), StringComparison.OrdinalIgnoreCase)))
        ).OrderByDescending(e => e.EntryDate).ToList();

        totalPages = (int)Math.Ceiling(filteredEntries.Count / (double)pageSize);
        currentPage = 1;
        LoadPage();

        ComputeStreaks();
        ComputeMissedDays();
    }

    private void ClearFilters()
    {
        searchText = "";
        filterDate = null;
        filterMood = "";
        filterTags = "";
        ApplyFilters();
    }

    private void LoadPage()
    {
        if (filteredEntries == null) return;
        pagedEntries = filteredEntries
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private void NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            LoadPage();
        }
    }

    private void PrevPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            LoadPage();
        }
    }

    private bool CanPrev => currentPage > 1;
    private bool CanNext => currentPage < totalPages;

    private async Task DeleteEntry(JournalEntry entry)
    {
        await JournalService.DeleteEntryAsync(entry);
        entries?.Remove(entry);
        ApplyFilters();
    }

    // Streak Tracking Logic
    private void ComputeStreaks()
    {
        var dates = filteredEntries.Select(e => e.EntryDate.Date).Distinct().OrderBy(d => d).ToList();
        int currentStreak = 0, maxStreak = 0;
        DateTime? prev = null;

        foreach (var d in dates)
        {
            if (prev.HasValue && (d - prev.Value).Days == 1)
            {
                currentStreak++;
            }
            else
            {
                currentStreak = 1;
            }
            maxStreak = Math.Max(maxStreak, currentStreak);
            prev = d;
        }

        dailyStreak = currentStreak;
        longestStreak = maxStreak;
    }

    private void ComputeMissedDays()
    {
        missedDays.Clear();
        if (!filteredEntries.Any()) return;

        var start = filteredEntries.Min(e => e.EntryDate.Date);
        var end = filteredEntries.Max(e => e.EntryDate.Date);

        var range = Enumerable.Range(0, (end - start).Days + 1)
            .Select(offset => start.AddDays(offset))
            .ToList();

        var entryDates = filteredEntries.Select(e => e.EntryDate.Date).ToHashSet();
        missedDays = range.Where(d => !entryDates.Contains(d)).ToList();
    }
}
